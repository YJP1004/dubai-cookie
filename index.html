<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‘ë°”ì´ì«€ë“ì¿ í‚¤ íƒ€ì´ì¿¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 20px;
            padding-bottom: 50px;
        }

        .game-container {
            background: #fff;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
        }

        .money {
            font-size: 28px;
            color: #e74c3c;
            font-weight: bold;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
        }

        .workstation {
            background: linear-gradient(145deg, #f5e6d3, #e8d4bc);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 3px solid #c9a66b;
        }

        .stage-display {
            text-align: center;
            margin-bottom: 15px;
        }

        .stage-title {
            font-size: 18px;
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 5px;
        }

        .stage-instruction {
            font-size: 18px;
            color: #666;
        }

        .cookie-visual {
            width: 180px;
            height: 180px;
            margin: 20px auto;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 60px;
            transition: all 0.3s ease;
            cursor: pointer;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: #f5e6d3;
        }

        .cookie-visual:hover {
            transform: scale(1.05);
        }

        .cookie-visual:active {
            transform: scale(0.95);
        }

        /* ë‹¨ê³„ë³„ ì¿ í‚¤ ë¹„ì£¼ì–¼ - ì´ë¯¸ì§€ ì‚¬ìš© */
        .stage-empty { background-image: url('images/cookie.png'); }
        .stage-flatten { background-image: url('images/step1.png'); }
        .stage-filling { background-image: url('images/step2.png'); }
        .stage-rolling { background-image: url('images/step3.png'); }
        .stage-powder { background-image: url('images/step4.png'); }
        .stage-complete { background-image: url('images/cookie.png'); box-shadow: 0 0 30px gold; }

        /* íƒ€ì´ë° ë°” */
        .timing-container {
            display: none;
            margin: 15px 0;
        }

        .timing-container.active {
            display: block;
        }

        .timing-bar {
            height: 30px;
            background: #eee;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }

        .timing-zones {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
        }

        .zone {
            height: 100%;
        }

        .zone-bad { background: #e74c3c; flex: 1; }
        .zone-normal { background: #f39c12; flex: 1; }
        .zone-good { background: #3498db; flex: 1; }
        .zone-perfect { background: #2ecc71; flex: 1; }
        .zone-good2 { background: #3498db; flex: 1; }
        .zone-normal2 { background: #f39c12; flex: 1; }
        .zone-bad2 { background: #e74c3c; flex: 1; }

        .timing-indicator {
            position: absolute;
            width: 6px;
            height: 100%;
            background: #333;
            top: 0;
            left: 0;
            transition: left 0.05s linear;
        }

        .timing-label {
            text-align: center;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }

        /* ë‹¹ê¸°ê¸° ê²Œì´ì§€ */
        .pull-container {
            display: none;
            margin: 15px 0;
        }

        .pull-container.active {
            display: block;
        }

        .pull-bar {
            height: 30px;
            background: #eee;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }

        .pull-progress {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #2ecc71);
            width: 0%;
            transition: width 0.1s;
            border-radius: 15px;
        }

        .pull-label {
            text-align: center;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }

        /* ì¬ë£Œ ë²„íŠ¼ (2ë‹¨ê³„) */
        .ingredient-container {
            display: none;
            margin: 15px 0;
        }

        .ingredient-container.active {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .ingredient-btn {
            padding: 15px 20px;
            font-size: 16px;
            border: 3px solid #ddd;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .ingredient-btn:hover {
            transform: scale(1.05);
            border-color: #3498db;
        }

        .ingredient-btn.added {
            background: #2ecc71;
            border-color: #27ae60;
            color: white;
            transform: scale(0.95);
        }

        .ingredient-btn.added:hover {
            transform: scale(0.95);
        }

        .ingredient-icon {
            font-size: 30px;
        }

        .ingredient-name {
            font-size: 12px;
            font-weight: bold;
        }

        /* íŒŒìš°ë” íƒ­ (4ë‹¨ê³„) */
        .powder-container {
            display: none;
            margin: 15px 0;
            text-align: center;
        }

        .powder-container.active {
            display: block;
        }

        .powder-progress {
            height: 30px;
            background: #eee;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .powder-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b4513, #d2691e);
            width: 0%;
            transition: width 0.1s;
            border-radius: 15px;
        }

        .powder-tap-btn {
            padding: 20px 40px;
            font-size: 20px;
            background: linear-gradient(145deg, #8b4513, #a0522d);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .powder-tap-btn:active {
            transform: scale(0.9);
        }

        .powder-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* ë‹¹ê¸°ê¸° ì¤‘ ì´ë¯¸ì§€ íš¨ê³¼ - ëŠ˜ì–´ë‚¨ ì—†ì´ ì‚´ì§ í”ë“¤ë¦¼ë§Œ */
        .cookie-visual.pulling {
            animation: shake 0.1s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(3px); }
        }

        /* ì•¡ì…˜ ë²„íŠ¼ */
        .action-btn {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-sell {
            background: linear-gradient(145deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn-disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
        }

        /* ì†ë‹˜ ì˜ì—­ */
        .customer-area {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }


        .customer-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .customer {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .customer-emoji {
            font-size: 30px;
        }

        .customer-info {
            flex: 1;
        }

        .customer-order {
            font-size: 14px;
            font-weight: bold;
        }

        .customer-patience {
            height: 6px;
            background: #eee;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .patience-bar {
            height: 100%;
            background: #2ecc71;
            transition: width 0.5s, background 0.5s;
        }

        .customer-reward {
            font-weight: bold;
            color: #e74c3c;
        }

        .no-customer {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        /* ì™„ì„±ëœ ì¿ í‚¤ ì €ì¥ì†Œ */
        .cookie-storage {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .stored-cookie {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
            background-image: url('images/cookie.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border: 3px solid transparent;
        }

        .stored-cookie:hover {
            transform: scale(1.2);
        }

        .cookie-perfect { border-color: gold; box-shadow: 0 0 10px gold; }
        .cookie-good { border-color: #3498db; box-shadow: 0 0 10px #3498db; }
        .cookie-normal { border-color: #f39c12; box-shadow: 0 0 10px #f39c12; }
        .cookie-failed { border-color: #95a5a6; opacity: 0.7; }

        /* ë°°ë„ˆ */
        .banner {
            margin-top: 20px;
            text-align: center;
        }

        .banner a {
            display: block;
            padding: 20px 30px;
            background: linear-gradient(145deg, #6B3E2E, #4E2A1E);
            color: white;
            text-decoration: none;
            border-radius: 15px;
            font-size: 28px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }

        .banner a:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .banner a:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>ë‘ë°”ì´ì«€ë“ì¿ í‚¤ íƒ€ì´ì¿¤</h1>
            <div class="money" id="money">0ì›</div>
        </div>

        <div class="stats">
            <span>ë§Œë“  ì¿ í‚¤: <strong id="totalCookies">0</strong>ê°œ</span>
            <span>ì„œë¹™: <strong id="totalServed">0</strong>ëª…</span>
        </div>

        <div class="workstation">
            <div class="stage-display">
                <div class="stage-title" id="stageTitle">ì‘ì—…ëŒ€ë¥¼ í´ë¦­í•˜ì„¸ìš”!</div>
                <div class="stage-instruction" id="stageInstruction">ë‘ì«€ì¿  ë§Œë“¤ê¸°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤</div>
            </div>

            <div class="cookie-visual stage-empty" id="cookieVisual" onclick="handleClick()">
            </div>

            <!-- ë‹¹ê¸°ê¸° ê²Œì´ì§€ (1ë‹¨ê³„) -->
            <div class="pull-container" id="pullContainer">
                <div class="pull-bar">
                    <div class="pull-progress" id="pullProgress"></div>
                </div>
                <div class="pull-label">â¡ï¸ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì­‰ ë‹¹ê¸°ì„¸ìš”!</div>
            </div>

            <!-- ì¬ë£Œ ë²„íŠ¼ (2ë‹¨ê³„) -->
            <div class="ingredient-container" id="ingredientContainer">
                <button class="ingredient-btn" id="kadaifBtn" onclick="addIngredient('kadaif')">
                    <span class="ingredient-icon">ğŸŒ¾</span>
                    <span class="ingredient-name">ì¹´ë‹¤ì´í”„</span>
                </button>
                <button class="ingredient-btn" id="pistachioBtn" onclick="addIngredient('pistachio')">
                    <span class="ingredient-icon">ğŸ’š</span>
                    <span class="ingredient-name">í”¼ìŠ¤íƒ€ì¹˜ì˜¤</span>
                </button>
            </div>

            <!-- íŒŒìš°ë” íƒ­ (4ë‹¨ê³„) -->
            <div class="powder-container" id="powderContainer">
                <div class="powder-progress">
                    <div class="powder-fill" id="powderFill"></div>
                </div>
                <button class="powder-tap-btn" onclick="tapPowder()">ğŸ« í†¡í†¡!</button>
                <div class="powder-label">ë²„íŠ¼ì„ ë¹ ë¥´ê²Œ íƒ­í•˜ì„¸ìš”!</div>
            </div>

            <!-- íƒ€ì´ë° ê²Œì´ì§€ (3ë‹¨ê³„) -->
            <div class="timing-container" id="timingContainer">
                <div class="timing-bar">
                    <div class="timing-zones">
                        <div class="zone zone-bad"></div>
                        <div class="zone zone-normal"></div>
                        <div class="zone zone-good"></div>
                        <div class="zone zone-perfect"></div>
                        <div class="zone zone-good2"></div>
                        <div class="zone zone-normal2"></div>
                        <div class="zone zone-bad2"></div>
                    </div>
                    <div class="timing-indicator" id="timingIndicator"></div>
                </div>
                <div class="timing-label">íƒ€ì´ë°ì— ë§ì¶° í´ë¦­!</div>
            </div>

            <button class="action-btn btn-primary" id="actionBtn" onclick="handleClick()">
                ì‹œì‘í•˜ê¸°
            </button>
        </div>

        <!-- ì™„ì„±ëœ ì¿ í‚¤ -->
        <div class="customer-area">
            <div class="customer-title">ì™„ì„±ëœ ì¿ í‚¤ (í´ë¦­í•´ì„œ íŒë§¤)</div>
            <div class="cookie-storage" id="cookieStorage">
                <div class="no-customer">ì•„ì§ ì™„ì„±ëœ ì¿ í‚¤ê°€ ì—†ì–´ìš”</div>
            </div>
        </div>

        <!-- ì†ë‹˜ -->
        <div class="customer-area">
            <div class="customer-title">ëŒ€ê¸° ì¤‘ì¸ ì†ë‹˜</div>
            <div id="customerList">
                <div class="no-customer">ì†ë‹˜ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
            </div>
        </div>

        <!-- ë°°ë„ˆ -->
        <div class="banner">
            <a href="https://marpple.shop/kr/jjinggu" id="shopBanner" target="_blank">ğŸ›’ ì°¡êµ¬ìƒµ êµ¬ê²½í•˜ê¸°</a>
        </div>
        <div class="banner">
            <a href="https://lottopick.kr/" id="shopBanner2" target="_blank">ğŸ ë¡œë˜ë²ˆí˜¸ ìƒì„±ê¸°</a>
        </div>
    </div>

    <script>
        // ê²Œì„ ìƒíƒœ
        const game = {
            money: 0,
            totalCookies: 0,
            totalServed: 0,
            currentStage: 0, // 0: empty, 1: flatten, 2: filling, 3: rolling, 4: powder, 5: complete
            completedCookies: [], // {quality: 'perfect'|'good'|'normal'|'failed', price: number}
            customers: [],
            timingValue: 0,
            timingDirection: 1,
            timingInterval: null,
            maxCustomers: 3,
            customerSpawnInterval: null,
            // ë‹¹ê¸°ê¸° ê´€ë ¨
            isPulling: false,
            pullStartX: 0,
            pullProgress: 0,
            // ì¬ë£Œ ê´€ë ¨ (2ë‹¨ê³„)
            ingredients: { kadaif: false, pistachio: false },
            // íŒŒìš°ë” ê´€ë ¨ (4ë‹¨ê³„)
            powderProgress: 0,
            powderTarget: 10 // 10ë²ˆ íƒ­í•˜ë©´ ì™„ë£Œ
        };

        // ë‹¨ê³„ ì •ë³´
        const stages = [
            { title: 'ì‘ì—…ëŒ€ë¥¼ í´ë¦­í•˜ì„¸ìš”!', instruction: 'ë‘ì«€ì¿  ë§Œë“¤ê¸°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤', btn: 'ì‹œì‘í•˜ê¸°' },
            { title: '1ë‹¨ê³„: ë–¼ì–´ë‚´ê¸°', instruction: 'ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì­‰ ë‹¹ê²¨ì„œ ë§ˆì‹œë©œë¡œìš°ë¥¼ ë–¼ì–´ë‚´ì„¸ìš”!', btn: '' },
            { title: '2ë‹¨ê³„: ë‚´ìš©ë¬¼ ì˜¬ë¦¬ê¸°', instruction: 'ì¬ë£Œ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”!', btn: '' },
            { title: '3ë‹¨ê³„: ë™ê·¸ë—ê²Œ ë§ê¸°', instruction: 'íƒ€ì´ë°ì— ë§ì¶° í´ë¦­!', btn: 'ë§ê¸°!' },
            { title: '4ë‹¨ê³„: íŒŒìš°ë” ë¿Œë¦¬ê¸°', instruction: 'ë²„íŠ¼ì„ ë¹ ë¥´ê²Œ íƒ­í•˜ì„¸ìš”!', btn: '' }
        ];

        // DOM ìš”ì†Œ
        const elements = {
            money: document.getElementById('money'),
            totalCookies: document.getElementById('totalCookies'),
            totalServed: document.getElementById('totalServed'),
            stageTitle: document.getElementById('stageTitle'),
            stageInstruction: document.getElementById('stageInstruction'),
            cookieVisual: document.getElementById('cookieVisual'),
            actionBtn: document.getElementById('actionBtn'),
            timingContainer: document.getElementById('timingContainer'),
            timingIndicator: document.getElementById('timingIndicator'),
            pullContainer: document.getElementById('pullContainer'),
            pullProgress: document.getElementById('pullProgress'),
            ingredientContainer: document.getElementById('ingredientContainer'),
            kadaifBtn: document.getElementById('kadaifBtn'),
            pistachioBtn: document.getElementById('pistachioBtn'),
            powderContainer: document.getElementById('powderContainer'),
            powderFill: document.getElementById('powderFill'),
            cookieStorage: document.getElementById('cookieStorage'),
            customerList: document.getElementById('customerList')
        };

        // í´ë¦­ í•¸ë“¤ëŸ¬
        function handleClick() {
            switch (game.currentStage) {
                case 0: // ì‹œì‘
                    startCooking();
                    break;
                case 1: // í”¼ ë–¼ì–´ë‚´ê¸° - ë“œë˜ê·¸ë¡œ ì²˜ë¦¬
                    break;
                case 2: // ë‚´ìš©ë¬¼ - ì¬ë£Œ ë²„íŠ¼ìœ¼ë¡œ ì²˜ë¦¬
                    break;
                case 3: // ë§ê¸° (íƒ€ì´ë°)
                    finishRolling();
                    break;
                case 4: // íŒŒìš°ë” - íƒ­ ë²„íŠ¼ìœ¼ë¡œ ì²˜ë¦¬
                    break;
            }
        }

        // 1ë‹¨ê³„ ì‹œì‘ - ë‹¹ê¸°ê¸° ëª¨ë“œ í™œì„±í™”
        function startCooking() {
            game.currentStage = 1;
            game.pullProgress = 0;
            elements.pullContainer.classList.add('active');
            elements.pullProgress.style.width = '0%';
            elements.actionBtn.style.display = 'none';
            updateUI();
        }

        // 1ë‹¨ê³„: í”¼ ë–¼ì–´ë‚´ê¸° ì™„ë£Œ
        function flattenDough() {
            elements.pullContainer.classList.remove('active');
            elements.cookieVisual.classList.remove('pulling');
            game.currentStage = 2;
            game.isPulling = false;
            // ì¬ë£Œ ìƒíƒœ ë¦¬ì…‹
            game.ingredients = { kadaif: false, pistachio: false };
            elements.kadaifBtn.classList.remove('added');
            elements.pistachioBtn.classList.remove('added');
            // ì¬ë£Œ ë²„íŠ¼ í‘œì‹œ
            elements.ingredientContainer.classList.add('active');
            elements.actionBtn.style.display = 'none';
            updateUI();
        }

        // 2ë‹¨ê³„: ì¬ë£Œ ì¶”ê°€
        function addIngredient(type) {
            if (game.currentStage !== 2) return;

            game.ingredients[type] = true;

            if (type === 'kadaif') {
                elements.kadaifBtn.classList.add('added');
            } else {
                elements.pistachioBtn.classList.add('added');
            }

            // ë‘˜ ë‹¤ ì¶”ê°€ë˜ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ
            if (game.ingredients.kadaif && game.ingredients.pistachio) {
                setTimeout(() => {
                    elements.ingredientContainer.classList.remove('active');
                    game.currentStage = 3;
                    startTiming();
                    updateUI();
                }, 500);
            }
        }

        // ë‹¹ê¸°ê¸° ì‹œì‘
        function startPull(x) {
            if (game.currentStage !== 1) return;
            game.isPulling = true;
            game.pullStartX = x;
            elements.cookieVisual.classList.add('pulling');
        }

        // ë‹¹ê¸°ê¸° ì¤‘
        function updatePull(x) {
            if (!game.isPulling || game.currentStage !== 1) return;

            const pullDistance = x - game.pullStartX;
            game.pullProgress = Math.min(100, Math.max(0, pullDistance / 2));

            elements.pullProgress.style.width = game.pullProgress + '%';

            // 100% ë„ë‹¬í•˜ë©´ ì™„ë£Œ
            if (game.pullProgress >= 100) {
                flattenDough();
            }
        }

        // ë‹¹ê¸°ê¸° ë (ì¤‘ê°„ì— ë†“ìœ¼ë©´ ë¦¬ì…‹)
        function endPull() {
            if (!game.isPulling || game.currentStage !== 1) return;

            if (game.pullProgress < 100) {
                // ë¦¬ì…‹
                game.pullProgress = 0;
                elements.pullProgress.style.width = '0%';
                elements.cookieVisual.style.transform = '';
                elements.cookieVisual.classList.remove('pulling');
            }
            game.isPulling = false;
        }


        // íƒ€ì´ë° ì‹œì‘
        function startTiming() {
            game.timingValue = 0;
            game.timingDirection = 1;
            elements.timingContainer.classList.add('active');

            game.timingInterval = setInterval(() => {
                game.timingValue += game.timingDirection * 2;
                if (game.timingValue >= 100 || game.timingValue <= 0) {
                    game.timingDirection *= -1;
                }
                elements.timingIndicator.style.left = game.timingValue + '%';
            }, 30);
        }

        // 3ë‹¨ê³„: ë§ê¸° ì™„ë£Œ
        function finishRolling() {
            clearInterval(game.timingInterval);
            elements.timingContainer.classList.remove('active');

            // í’ˆì§ˆ íŒì •
            const value = game.timingValue;
            let quality, qualityName;

            if (value >= 40 && value <= 60) {
                quality = 'perfect';
                qualityName = 'ì™„ë²½!';
            } else if (value >= 25 && value <= 75) {
                quality = 'good';
                qualityName = 'ì¢‹ìŒ!';
            } else if (value >= 15 && value <= 85) {
                quality = 'normal';
                qualityName = 'ë³´í†µ';
            } else {
                quality = 'failed';
                qualityName = 'ì‹¤íŒ¨...';
            }

            game.currentQuality = quality;
            game.currentStage = 4;
            // íŒŒìš°ë” íƒ­ ì‹œì‘
            game.powderProgress = 0;
            elements.powderFill.style.width = '0%';
            elements.powderContainer.classList.add('active');
            elements.actionBtn.style.display = 'none';
            updateUI();
        }

        // 4ë‹¨ê³„: íŒŒìš°ë” íƒ­
        function tapPowder() {
            if (game.currentStage !== 4) return;

            game.powderProgress++;
            const percent = (game.powderProgress / game.powderTarget) * 100;
            elements.powderFill.style.width = percent + '%';

            // ì™„ë£Œ! -> ë°”ë¡œ ì²˜ìŒìœ¼ë¡œ
            if (game.powderProgress >= game.powderTarget) {
                elements.powderContainer.classList.remove('active');
                completeCookie();
                // ë°”ë¡œ ì²˜ìŒ ë‹¨ê³„ë¡œ ë¦¬ì…‹
                game.currentStage = 0;
                game.currentQuality = null;
                elements.actionBtn.style.display = 'block';
                updateUI();
            }
        }

        // ì¿ í‚¤ ì™„ì„±
        function completeCookie() {
            const quality = game.currentQuality || 'normal';
            const prices = { perfect: 100, good: 70, normal: 50, failed: 20 };

            game.completedCookies.push({
                quality: quality,
                price: prices[quality]
            });

            game.totalCookies++;
            updateCookieStorage();
        }

        // ìŠ¤í…Œì´ì…˜ ë¦¬ì…‹
        function resetStation() {
            game.currentStage = 0;
            game.currentQuality = null;
            updateUI();
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            const stage = stages[game.currentStage];
            elements.stageTitle.textContent = stage.title;
            elements.stageInstruction.textContent = stage.instruction;
            elements.actionBtn.textContent = stage.btn;

            // ì¿ í‚¤ ë¹„ì£¼ì–¼ í´ë˜ìŠ¤ (ì´ë¯¸ì§€ëŠ” CSSì—ì„œ ì²˜ë¦¬)
            const stageClasses = ['stage-empty', 'stage-flatten', 'stage-filling', 'stage-rolling', 'stage-powder'];
            elements.cookieVisual.className = 'cookie-visual ' + stageClasses[game.currentStage];

            // ëˆ & í†µê³„
            elements.money.textContent = game.money.toLocaleString() + 'ì›';
            elements.totalCookies.textContent = game.totalCookies;
            elements.totalServed.textContent = game.totalServed;
        }

        // ì¿ í‚¤ ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
        function updateCookieStorage() {
            if (game.completedCookies.length === 0) {
                elements.cookieStorage.innerHTML = '<div class="no-customer">ì•„ì§ ì™„ì„±ëœ ì¿ í‚¤ê°€ ì—†ì–´ìš”</div>';
                return;
            }

            elements.cookieStorage.innerHTML = game.completedCookies.map((cookie, index) => `
                <div class="stored-cookie cookie-${cookie.quality}" onclick="sellCookie(${index})" title="${cookie.price}ì›">
                </div>
            `).join('');
        }

        // ì¿ í‚¤ íŒë§¤
        function sellCookie(index) {
            if (game.customers.length === 0) {
                alert('ì†ë‹˜ì´ ì—†ì–´ìš”!');
                return;
            }

            const cookie = game.completedCookies[index];
            const customer = game.customers[0];

            // íŒë§¤
            const reward = cookie.price + Math.floor(customer.patience / 10);
            game.money += reward;
            game.totalServed++;

            // ì œê±°
            game.completedCookies.splice(index, 1);
            game.customers.shift();

            updateCookieStorage();
            updateCustomerList();
            updateUI();
        }

        // ì†ë‹˜ ìƒì„±
        function spawnCustomer() {
            if (game.customers.length >= game.maxCustomers) return;

            const emojis = ['ğŸ˜Š', 'ğŸ˜„', 'ğŸ¥°', 'ğŸ˜‹', 'ğŸ¤¤', 'ğŸ˜'];
            const customer = {
                emoji: emojis[Math.floor(Math.random() * emojis.length)],
                patience: 100,
                maxPatience: 100,
                reward: 50 + Math.floor(Math.random() * 30)
            };

            game.customers.push(customer);
            updateCustomerList();
        }

        // ì†ë‹˜ ì¸ë‚´ì‹¬ ê°ì†Œ
        function updateCustomerPatience() {
            game.customers.forEach((customer, index) => {
                customer.patience -= 1;
                if (customer.patience <= 0) {
                    game.customers.splice(index, 1);
                }
            });
            updateCustomerList();
        }

        // ì†ë‹˜ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateCustomerList() {
            if (game.customers.length === 0) {
                elements.customerList.innerHTML = '<div class="no-customer">ì†ë‹˜ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>';
                return;
            }

            elements.customerList.innerHTML = game.customers.map((customer, index) => {
                const patiencePercent = (customer.patience / customer.maxPatience) * 100;
                const patienceColor = patiencePercent > 50 ? '#2ecc71' : patiencePercent > 25 ? '#f39c12' : '#e74c3c';

                return `
                    <div class="customer">
                        <div class="customer-emoji">${customer.emoji}</div>
                        <div class="customer-info">
                            <div class="customer-order">ë‘ì«€ì¿  1ê°œ ì£¼ì„¸ìš”!</div>
                            <div class="customer-patience">
                                <div class="patience-bar" style="width: ${patiencePercent}%; background: ${patienceColor}"></div>
                            </div>
                        </div>
                        <div class="customer-reward">${customer.reward}ì›</div>
                    </div>
                `;
            }).join('');
        }

        // ê²Œì„ ì´ˆê¸°í™”
        function init() {
            updateUI();
            updateCookieStorage();
            updateCustomerList();

            // ì†ë‹˜ ìƒì„± (5ì´ˆë§ˆë‹¤)
            game.customerSpawnInterval = setInterval(spawnCustomer, 7000);

            // ì†ë‹˜ ì¸ë‚´ì‹¬ ê°ì†Œ (1ì´ˆë§ˆë‹¤)
            setInterval(updateCustomerPatience, 1000);

            // ì²« ì†ë‹˜ ë°”ë¡œ ìƒì„±
            setTimeout(spawnCustomer, 2000);

            // ë‹¹ê¸°ê¸° ì´ë²¤íŠ¸ (ë§ˆìš°ìŠ¤)
            elements.cookieVisual.addEventListener('mousedown', (e) => {
                startPull(e.clientX);
            });
            document.addEventListener('mousemove', (e) => {
                updatePull(e.clientX);
            });
            document.addEventListener('mouseup', () => {
                endPull();
            });

            // ë‹¹ê¸°ê¸° ì´ë²¤íŠ¸ (í„°ì¹˜ - ëª¨ë°”ì¼)
            elements.cookieVisual.addEventListener('touchstart', (e) => {
                if (game.currentStage === 1) {
                    e.preventDefault();
                }
                startPull(e.touches[0].clientX);
            }, { passive: false });
            document.addEventListener('touchmove', (e) => {
                if (game.isPulling) {
                    e.preventDefault();
                }
                updatePull(e.touches[0].clientX);
            }, { passive: false });
            document.addEventListener('touchend', () => {
                endPull();
            });
        }

        // ì‹œì‘
        init();
    </script>
</body>
</html>
